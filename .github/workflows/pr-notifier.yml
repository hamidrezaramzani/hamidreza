name: Notify Discord on PR Activities

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [assigned]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        uses: actions/github-script@v6
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          script: |
            const { action, review, pull_request } = context.payload;

            // Helper function to send Discord message
            async function sendToDiscord(message) {
              const response = await fetch(process.env.DISCORD_WEBHOOK_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content: message }),
              });

              if (!response.ok) {
                throw new Error(`Failed to send message: ${response.statusText}`);
              }
            }

            let message;

            // Handle "Approved"
            if (action === "submitted" && review.state === "approved") {
              message = `
              ${pull_request.title}
              > :bust_in_silhouette: **User**: ${review.user.login}
              :herb: **Branch**: ${pull_request.head.ref}
              :deciduous_tree: **Base Branch**: ${pull_request.base.ref}
              :open_file_folder: **Repository**: ${github.context.repo.owner}/${github.context.repo.repo}
              :link: **Pull Request Link**: ${pull_request.html_url}
              :white_check_mark: **Activity**: Approved
              `.trim();
            }

            // Handle "Request Changes"
            if (action === "submitted" && review.state === "changes_requested") {
              message = `
              ${pull_request.title}
              > :bust_in_silhouette: **User**: ${review.user.login}
              :herb: **Branch**: ${pull_request.head.ref}
              :deciduous_tree: **Base Branch**: ${pull_request.base.ref}
              :open_file_folder: **Repository**: ${github.context.repo.owner}/${github.context.repo.repo}
              :link: **Pull Request Link**: ${pull_request.html_url}
              :x: **Activity**: Changes Requested
              `.trim();
            }

            // Handle "Assignee"
            if (action === "assigned") {
              const assignee = pull_request.assignee ? pull_request.assignee.login : "Unknown";
              message = `
              ${pull_request.title}
              > :bust_in_silhouette: **User**: ${assignee}
              :herb: **Branch**: ${pull_request.head.ref}
              :deciduous_tree: **Base Branch**: ${pull_request.base.ref}
              :open_file_folder: **Repository**: ${github.context.repo.owner}/${github.context.repo.repo}
              :link: **Pull Request Link**: ${pull_request.html_url}
              :clipboard: **Activity**: Assigned
              `.trim();
            }

            // Send the message if it's defined
            if (message) {
              await sendToDiscord(message);
            } else {
              console.log("No matching condition for sending Discord message.");
            }

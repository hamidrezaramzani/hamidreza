name: Notify Discord on PR Activities

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [assigned]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        uses: actions/github-script@v6
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          script: |
            const { action, review, pull_request, repository } = context.payload;


            const repo = pull_request.head.html_url;
            const owner = context.repo.owner;

            const discordUserIds = {
             hamidrezaramzani: "995181976388640789",
            };

            async function sendToDiscord(message) {
              const response = await fetch(process.env.DISCORD_WEBHOOK_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content: message }),
              });

              if (!response.ok) {
                throw new Error(`Failed to send message: ${response.statusText}`);
              }
            }

            let message;

            if (action === "submitted" && review.state === "approved") {
              message = `
              ğŸš€ Pull Request Approved!
              
              ğŸ‘¤ Reviewer: ${review.user.login}
              ğŸ‘©â€ğŸ’» PR Creator: ${pull_request.user.login}
              ğŸŒ¿ Branch: ${pull_request.head.ref}
              ğŸŒ³ Base Branch: ${pull_request.base.ref}
              ğŸ“‚ Repository: ${repository.name}
              ğŸ”— Pull Request Link: ${pull_request.html_url}

              cc: <@${discordUserIds[pull_request.user.login]}>
              `.trim();
            }

            if (action === "submitted" && review.state === "changes_requested") {
              message = `
              :recycle: Pull Request Has Request Change
              
              ğŸ‘¤ Reviewer: ${review.user.login}
              ğŸ‘©â€ğŸ’» PR Creator: ${pull_request.user.login}
              ğŸŒ¿ Branch: ${pull_request.head.ref}
              ğŸŒ³ Base Branch: ${pull_request.base.ref}
              ğŸ“‚ Repository: ${repository.name}
              ğŸ”— Pull Request Link: ${pull_request.html_url}

              cc: <@${discordUserIds[pull_request.user.login]}>
              `.trim();
            }

            if (action === "assigned") {
              const assignee = pull_request.assignee ? pull_request.assignee.login : "Unknown";
              message = `
              ğŸ‘ Pr reviewer assigned
              
              ğŸ‘¤ Reviewer: ${review.user.login}
              ğŸ‘©â€ğŸ’» PR Creator: ${pull_request.user.login}
              ğŸŒ¿ Branch: ${pull_request.head.ref}
              ğŸŒ³ Base Branch: ${pull_request.base.ref}
              ğŸ“‚ Repository: ${repository.name}
              ğŸ”— Pull Request Link: ${pull_request.html_url}

              cc: <@${discordUserIds[pull_request.user.login]}>
              `.trim();
            }

            if (message) {
              await sendToDiscord(message);
            } else {
              console.log("No matching condition for sending Discord message.");
            }
